<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<f:view contentType="text/html">
    <h:head>
        <title>Taxi Hub</title>
        <meta content='text/html; charset=UTF-8' http-equiv="Content-Type"/>
        <link href="#{resource['images/shortcut_icon.png']}" rel="shortcut icon"/>
        <h:outputStylesheet name="css/taxi.css"/>
        <h:outputScript name="js/starter.js"/>
        <h:outputScript name="js/socket.io-2.2.0.js"/>
        <h:outputScript name="js/StringeeSDK-1.5.10.js"/>
        <h:outputScript name="js/StringeeSoftPhone-lastest.js" />
    </h:head>
    <h:body styleClass="skin-blue layout-top-nav">
        <p:ajaxStatus style="display: none">
            <f:facet name="start">
                <p:graphicImage name="/images/ajaxloading.gif" />
            </f:facet>
        </p:ajaxStatus>
        <p:ajaxStatus onstart="startTimer();"
                      onerror="PF('errorDialog').show();stopTimer();PF('statusDialog').hide()"
                      onsuccess="PF('statusDialog').hide();stopTimer();" />

        <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
            <p:graphicImage name="/images/ajaxloading.gif" />
        </p:dialog>
        <p:dialog modal="true" widgetVar="errorDialog"
                  header="Có lỗi xảy ra" draggable="false" closable="false" resizable="false">
            Nhấn F5 để tải lại trang
        </p:dialog>
        <ui:include src="header.xhtml"/>
        <p:spacer height="50px"/>
        <div style="margin-left: 15px; margin-right: 15px">
            <ui:insert name="content" >
            </ui:insert>
        </div>

        <p:remoteCommand name="showCallDialog" actionListener="#{callManagementDialogComponent.updateCustomerInfoFromUI}" oncomplete="PF('callDialog').show()" update="@([id$=customerInfo])"/>

        <p:dialog modal="true" widgetVar="callDialog"
                  width="700"
                  height="600"
                  header="Cuộc gọi" draggable="true" closable="true" resizable="true">

            <div class="ui-g">
                <div class="ui-g-6">
                    <div id="callPosition"></div>
                </div>
                <div class="ui-g-6">
                    <h:form id="customerInfo">
                        <h4>Khách hàng</h4>
                        <p:fragment rendered="#{not empty callManagementDialogComponent.customerInfo.name}">
                            <p:link href="customer_detail.jsf?id=#{callManagementDialogComponent.customerInfo.id}" target="_blank">#{callManagementDialogComponent.customerInfo.name}</p:link>
                        </p:fragment>
                        <p:fragment rendered="#{empty callManagementDialogComponent.customerInfo.name}">
                            <p>Chưa có trong hệ thống</p>
                        </p:fragment>
                        <h4>Số điện thoại</h4>
                        <p id="phoneNumber">#{callManagementDialogComponent.customerInfo.phone}</p>
                        <input type="button" value="Gọi" class="call-btn" onclick="StringeeSoftPhone.makeCall('842471008847', $('#phoneNumber').text().replace(/^0/, '84')); return false;"/>
                    </h:form>
                </div>
            </div>

        </p:dialog>


        <script type="text/javascript">
            var t;

            function startTimer() {
                t = setTimeout("PF('statusDialog').show()", 1000);
            }

            function stopTimer() {
                clearTimeout(t);

            }
        </script>

        <script type="text/javascript">
            var config = {
                showMode: 'full',//full | min | none
                top: 45,
                left: 50,
                //right: 810,
                appendToElement: 'callPosition',
                arrowLeft: 155,
                arrowDisplay: 'top',//top | bottom | none

                //list your Stringee Number
                fromNumbers: [{alias: '02471008847', number: '842471008847'}]
            };
            StringeeSoftPhone.init(config);
            var access_token2 = 'eyJjdHkiOiJzdHJpbmdlZS1hcGk7dj0xIiwidHlwIjoiSldUIiwiYWxnIjoiSFMyNTYifQ.eyJqdGkiOiJTS3hXRVVWeUZZeWVQaEtvdlRNNHRNRGFHWDM1ZDZVdkItMTU2MTAxMzgxNCIsImlzcyI6IlNLeFdFVVZ5Rll5ZVBoS292VE00dE1EYUdYMzVkNlV2QiIsImV4cCI6MTU2MzYwNTgxNCwidXNlcklkIjoiaG9wbnYifQ.f-VOq_pVDa0CUTrwjNARjGicUb4h3AGvUi92_bwBzVI';

            StringeeSoftPhone.on('displayModeChange', function (event) {
                console.log('displayModeChange', event);
                if (event === 'min') {
                    StringeeSoftPhone.config({arrowLeft: 75});
                } else if (event === 'full') {
                    StringeeSoftPhone.config({arrowLeft: 155});
                }
            });

            StringeeSoftPhone.on('incomingCall', function (incomingcall) {
                showCallDialog([{name:'phone', value:incomingcall.fromNumber}]);
            });

            StringeeSoftPhone.on('requestNewToken', function () {
                console.log('requestNewToken+++++++');
                StringeeSoftPhone.connect(access_token2);
            });

            StringeeSoftPhone.connect(access_token2);
        </script>

    </h:body>

    <h:outputScript library="primefaces" name="jquery/jquery.js" target="head"/>
    <h:outputScript library="js" name="bootstrap.min.js" target="head"/>
    <h:outputScript library="js" name="admin-lte.min.js" target="head"/>
    <h:outputScript library="js" name="admintemplate.js" target="head"/>
    <h:outputScript library="js" name="slimscroll.min.js" target="head"/>

</f:view>
</html>
